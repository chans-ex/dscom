<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>개인정보 체크리스트</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    textarea {
      width: 100%;
      resize: vertical;
    }
    .status-O { background-color: #d0f0c0; }
    .status-일부 { background-color: #fff3cd; }
    .status-X { background-color: #f8d7da; }
    .btn {
      padding: 8px 12px;
      margin-right: 5px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn-danger { background: #dc3545; }
    .btn-success { background: #28a745; }
    .btn-primary { background: #17a2b8; }
    select {
      width: 100%;
    }
  </style>
</head>
<body>

  <h2>🔒 개인정보 보호 체크리스트</h2>

  <div style="margin-bottom: 10px;">
    <button class="btn btn-success" onclick="saveToSheetDB()">💾 저장</button>
    <button class="btn btn-primary" onclick="loadFromSheetDB()">📥 불러오기</button>
    <button class="btn btn-danger" onclick="addRow()">➕ 행 추가</button>
  </div>

  <table id="checklistTable">
    <thead>
      <tr>
        <th>번호</th>
        <th>점검영역</th>
        <th>점검항목</th>
        <th>개선방안</th>
        <th>현재상태</th>
        <th>상태</th>
        <th>관련 법령</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody>
      <!-- 불러오기 시 자동 생성 -->
    </tbody>
  </table>

  <script>
    const API_URL = "https://sheetdb.io/api/v1/gfnrpqrd52v6t"; // ←  SheetDB API 

    let nextId = 1;

    function addRow() {
      const tbody = document.querySelector('#checklistTable tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="number-col">${nextId++}</td>
        <td><textarea class="editable"></textarea></td>
        <td><textarea class="editable"></textarea></td>
        <td><textarea class="editable"></textarea></td>
        <td><textarea class="editable"></textarea></td>
        <td>
          <select class="status-select" onchange="updateStatusClass(this)">
            <option value="">선택</option>
            <option value="O">O</option>
            <option value="일부 개선 필요">일부 개선 필요</option>
            <option value="X">X</option>
          </select>
        </td>
        <td><textarea class="editable"></textarea></td>
        <td><button class="btn btn-danger" onclick="deleteRow(this)">삭제</button></td>
      `;
      tbody.appendChild(row);
    }

    function deleteRow(button) {
      const row = button.closest('tr');
      row.remove();
      updateRowNumbers();
    }

    function updateRowNumbers() {
      const rows = document.querySelectorAll('#checklistTable tbody tr');
      rows.forEach((row, index) => {
        row.querySelector('.number-col').textContent = index + 1;
      });
      nextId = rows.length + 1;
    }

    function updateStatusClass(selectElement) {
      const row = selectElement.closest('tr');
      row.className = '';
      const value = selectElement.value;
      if (value === "O") row.classList.add('status-O');
      else if (value === "일부 개선 필요") row.classList.add('status-일부');
      else if (value === "X") row.classList.add('status-X');
    }

    function saveToSheetDB() {
      const rows = document.querySelectorAll('#checklistTable tbody tr');
      const data = [];

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        data.push({
          id: cells[0].textContent.trim(),
          area: cells[1].querySelector('textarea').value,
          function: cells[2].querySelector('textarea').value,
          method: cells[3].querySelector('textarea').value,
          current: cells[4].querySelector('textarea').value,
          status: cells[5].querySelector('select').value,
          law: cells[6].querySelector('textarea').value || '',
          className: row.className
        });
      });

      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: data })
      })
      .then(res => res.json())
      .then(() => alert("✅ 저장 완료!"))
      .catch(err => alert("❌ 저장 실패: " + err));
    }

    function loadFromSheetDB() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector('#checklistTable tbody');
          tbody.innerHTML = '';
          nextId = data.length + 1;

          data.forEach(row => {
            const newRow = document.createElement('tr');
            newRow.className = row.className || '';

            newRow.innerHTML = `
              <td class="number-col">${row.id}</td>
              <td><textarea class="editable">${row.area || ''}</textarea></td>
              <td><textarea class="editable">${row.function || ''}</textarea></td>
              <td><textarea class="editable">${row.method || ''}</textarea></td>
              <td><textarea class="editable">${row.current || ''}</textarea></td>
              <td>
                <select class="status-select" onchange="updateStatusClass(this)">
                  <option value="">선택</option>
                  <option value="O" ${row.status === 'O' ? 'selected' : ''}>O</option>
                  <option value="일부 개선 필요" ${row.status === '일부 개선 필요' ? 'selected' : ''}>일부 개선 필요</option>
                  <option value="X" ${row.status === 'X' ? 'selected' : ''}>X</option>
                </select>
              </td>
              <td><textarea class="editable">${row.law || ''}</textarea></td>
              <td><button class="btn btn-danger" onclick="deleteRow(this)">삭제</button></td>
            `;

            tbody.appendChild(newRow);
            updateStatusClass(newRow.querySelector('.status-select'));
          });
        })
        .catch(err => alert("❌ 불러오기 실패: " + err));
    }
  </script>
</body>
</html>
